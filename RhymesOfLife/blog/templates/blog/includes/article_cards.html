{% load i18n wagtailimages_tags static avatar_tags %}

{% if page.live %}
  {% with href=page.url %}
    <article class="rl-card js-clickable-card" data-href="{{ href|default:'#' }}">
      <a class="rl-card__link" href="{{ href|default:'#' }}" aria-label="{{ page.title }}">
        {% if page.main_image %}
          {% image page.main_image fill-960x600 format-webp as img_960 %}
          {% image page.main_image fill-640x400 format-webp as img_640 %}
          <div class="rl-card__media">
            <img
              src="{{ img_960.url }}"
              width="{{ img_960.width }}"
              height="{{ img_960.height }}"
              alt="{{ page.title }}"
              loading="lazy"
              decoding="async"
              srcset="{{ img_640.url }} 640w, {{ img_960.url }} 960w"
              sizes="(max-width: 992px) 100vw, 50vw"
            >
          </div>
        {% else %}
          <div class="rl-card__media" aria-hidden="true"></div>
        {% endif %}

        <div class="rl-card__body">
          <div>
            <h2 class="rl-card__title">{{ page.title }}</h2>
          </div>

          <p class="rl-card__intro">{{ page.intro|truncatechars:150 }}</p>

          {# Tags disabled for now #}
          {# {% if page.tags.all %} #}
          {#   <div class="rl-card__tags" aria-label="{% trans 'Tags' %}"> #}
          {#     {% for tag in page.tags.all %} #}
          {#       <span class="rl-tag">{{ tag.name }}</span> #}
          {#     {% endfor %} #}
          {#   </div> #}
          {# {% endif %} #}

          <div class="rl-card__meta">
            <div class="rl-author">
              {% if page.author %}
                <img src="{% avatar_url page.author %}" alt="{% trans 'Avatar' %}">
                <span>
                  {{ page.author.first_name|default:page.author.user.username }}{% if page.author.last_name %} {{ page.author.last_name }}{% endif %}
                </span>
              {% else %}
                <span>{% trans "Anonymous author" %}</span>
              {% endif %}
            </div>

            <div class="rl-stats">
              <span class="rl-pill">
                <i class="bi bi-calendar3 me-1" aria-hidden="true"></i>{{ page.date|date:"j E Y" }}
              </span>
              <span class="rl-pill">
                <i class="bi bi-heart me-1" aria-hidden="true"></i>{{ page.likes_count }}
              </span>
              <span class="rl-pill">
                <i class="bi bi-chat-left-text me-1" aria-hidden="true"></i>{{ page.comments_count }}
              </span>
            </div>
          </div>
        </div>
      </a>
    </article>
  {% endwith %}
{% else %}
  {% url 'edit_article' page.id as edit_url %}
  {% with href=edit_url|add:"?edit=1" %}
    <article class="rl-card js-clickable-card" data-href="{{ href }}">
      <a class="rl-card__link" href="{{ href }}" aria-label="{{ page.title }}">
        {% if page.main_image %}
          {% image page.main_image fill-960x600 format-webp as img_960 %}
          {% image page.main_image fill-640x400 format-webp as img_640 %}
          <div class="rl-card__media">
            <img
              src="{{ img_960.url }}"
              width="{{ img_960.width }}"
              height="{{ img_960.height }}"
              alt="{{ page.title }}"
              loading="lazy"
              decoding="async"
              srcset="{{ img_640.url }} 640w, {{ img_960.url }} 960w"
              sizes="(max-width: 992px) 100vw, 50vw"
            >
          </div>
        {% else %}
          <div class="rl-card__media" aria-hidden="true"></div>
        {% endif %}

        <div class="rl-card__body">
          <div class="d-flex align-items-start justify-content-between gap-2">
            <h2 class="rl-card__title mb-0">{{ page.title }}</h2>
            <span class="badge bg-secondary">{% trans "Draft" %}</span>
          </div>

          <p class="rl-card__intro">{{ page.intro|truncatechars:150 }}</p>

          {# Tags disabled for now #}
          {# {% if page.tags.all %} #}
          {#   <div class="rl-card__tags" aria-label="{% trans 'Tags' %}"> #}
          {#     {% for tag in page.tags.all %} #}
          {#       <span class="rl-tag">{{ tag.name }}</span> #}
          {#     {% endfor %} #}
          {#   </div> #}
          {# {% endif %} #}

          <div class="rl-card__meta">
            <div class="rl-author">
              {% if page.author %}
                <img src="{% avatar_url page.author %}" alt="{% trans 'Avatar' %}">
                <span>
                  {{ page.author.first_name|default:page.author.user.username }}{% if page.author.last_name %} {{ page.author.last_name }}{% endif %}
                </span>
              {% else %}
                <span>{% trans "Anonymous author" %}</span>
              {% endif %}
            </div>

            <div class="rl-stats">
              <span class="rl-pill">
                <i class="bi bi-calendar3 me-1" aria-hidden="true"></i>{{ page.date|date:"j E Y" }}
              </span>
              <span class="rl-pill">
                <i class="bi bi-heart me-1" aria-hidden="true"></i>{{ page.likes_count }}
              </span>
              <span class="rl-pill">
                <i class="bi bi-chat-left-text me-1" aria-hidden="true"></i>{{ page.comments_count }}
              </span>
            </div>
          </div>
        </div>
      </a>
    </article>
  {% endwith %}
{% endif %}
