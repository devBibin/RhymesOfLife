{% extends "base.html" %}
{% load i18n static %}

{% block content %}
<div class="container py-4">
  <h1 class="h4 mb-3">{% trans "Help requests" %}</h1>

  <form id="hr-filter" class="row g-2 mb-3">
    <div class="col-md-3">
      <select class="form-select" name="status" id="hr-status">
        <option value="open">{% trans "Open" %}</option>
        <option value="processed">{% trans "Processed" %}</option>
        <option value="all">{% trans "All" %}</option>
      </select>
    </div>
    <div class="col-md-7">
      <input class="form-control" type="search" name="q" id="hr-q" placeholder="{% trans 'Search...' %}">
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" type="submit">{% trans "Apply" %}</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>#</th>
          <th>{% trans "Created" %}</th>
          <th>{% trans "Name" %}</th>
          <th>{% trans "Email" %}</th>
          <th style="width:45%">{% trans "Message" %}</th>
          <th>{% trans "Status" %}</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="hr-list"></tbody>
    </table>
  </div>

  <div id="hr-pager" class="mt-3"></div>
</div>

<script>
function getCookie(name){
  const m = document.cookie.match('(?:^|; )' + name.replace(/([.$?*|{}()[\]\\/+^])/g, '\\$1') + '=([^;]*)');
  return m ? decodeURIComponent(m[1]) : '';
}

let hrCurrentPage = 1;

async function hrLoad(page=1){
  hrCurrentPage = page;
  const status = document.getElementById('hr-status').value;
  const q = document.getElementById('hr-q').value || '';
  const u = new URL('{% url "staff_help_requests_data" %}', window.location.origin);
  u.searchParams.set('status', status);
  u.searchParams.set('q', q);
  u.searchParams.set('page', page);
  const resp = await fetch(u.toString(), {headers: {'X-Requested-With':'XMLHttpRequest'}});
  if(!resp.ok) return;
  const data = await resp.json();
  if(!data.ok) return;
  document.getElementById('hr-list').innerHTML = data.rows;
  document.getElementById('hr-pager').innerHTML = data.pager;
}

document.getElementById('hr-filter').addEventListener('submit', (e)=>{
  e.preventDefault();
  hrLoad(1);
});
document.getElementById('hr-status').addEventListener('change', ()=>hrLoad(1));

document.addEventListener('click', async (e) => {
  const pageBtn = e.target.closest('.hr-page-btn');
  if(pageBtn){
    e.preventDefault();
    const p = parseInt(pageBtn.dataset.page || '1', 10);
    hrLoad(p);
    return;
  }
  const btn = e.target.closest('.hr-toggle-btn');
  if(btn){
    const id = btn.dataset.id;
    const form = new FormData();
    form.append('id', id);
    form.append('action', btn.dataset.action);
    const resp = await fetch('{% url "staff_help_requests_api" %}', {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken')},
      body: form
    });
    if(!resp.ok) return;
    const data = await resp.json();
    if(!data.ok) return;
    hrLoad(hrCurrentPage);
  }
});

document.addEventListener('DOMContentLoaded', ()=>hrLoad(1));
</script>
{% endblock %}
