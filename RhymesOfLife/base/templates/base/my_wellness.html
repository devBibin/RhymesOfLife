{% extends "base.html" %}
{% load static i18n %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/new_styles.css' %}">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">ğŸ©º {% trans "My wellness" %}</h2>
    <button id="btn-settings" class="btn btn-outline-secondary btn-sm">{% trans "Notifications" %}</button>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form id="entry-form" class="row g-3" novalidate>
        {% csrf_token %}
        <div class="col-12 col-md-3">
          <label for="score" class="form-label">{% trans "Score (1-10)" %}</label>
          <input type="number" name="score" id="score" min="1" max="10" class="form-control" required>
        </div>
        <div class="col-12 col-md-9">
          <label for="note" class="form-label">{% trans "Comment" %}</label>
          <input type="text" name="note" id="note" class="form-control" placeholder="{% trans 'How do you feel today?' %}">
        </div>
        <div class="col-12 text-end">
          <button type="button" id="btn-save" class="btn btn-primary">{% trans "Save" %}</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="mb-3">{% trans "Trend" %}</h5>
      <canvas id="chart" height="120"></canvas>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">{% trans "Entries" %}</h5>
      <ul id="entries-list" class="list-group"></ul>
      <div id="no-entries" class="alert alert-info mb-0 d-none">{% trans "No entries yet." %}</div>
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">{% trans "Notifications" %}</h5></div>

        <div class="modal-body">
          <p class="text-muted small mb-3">
            {% trans "Choose how often to receive a reminder if you haven't added a wellness entry for the selected period. One reminder per day will be sent at the time below." %}
          </p>

          <div class="mb-3">
            <label for="rem-interval" class="form-label">{% trans "Reminder frequency" %}</label>
            <select id="rem-interval" class="form-select">
              <option value="0">{% trans "Never" %}</option>
              <option value="1">{% trans "Every day" %}</option>
              <option value="3">{% trans "Every 3 days" %}</option>
              <option value="7">{% trans "Every 7 days" %}</option>
            </select>
            <div class="form-text">
              {% trans "Set to Never to fully disable reminders." %}
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col">
              <label for="rem-hour" class="form-label">{% trans "Hour" %}</label>
              <input type="number" id="rem-hour" class="form-control" min="0" max="23">
            </div>
            <div class="col">
              <label for="rem-min" class="form-label">{% trans "Minute" %}</label>
              <input type="number" id="rem-min" class="form-control" min="0" max="59">
            </div>
          </div>
          <div class="form-text">
            {% trans "Your local time when the daily reminder may be sent." %}
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
          <button id="btn-save-settings" class="btn btn-primary">{% trans "Save" %}</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const apiEntries = "{% url 'wellness_entries_api' %}";
const apiSettings = "{% url 'wellness_settings_api' %}";
let chart;

function getCsrfToken() {
  const name = "csrftoken";
  const cookies = document.cookie ? document.cookie.split(";") : [];
  for (let c of cookies) {
    c = c.trim();
    if (c.startsWith(name + "=")) return decodeURIComponent(c.substring(name.length + 1));
  }
  return "";
}

function fetchEntries() {
  return fetch(apiEntries + "?days=90", { headers: { "X-Requested-With": "XMLHttpRequest" }, credentials: "same-origin" })
    .then(r => r.json());
}

function renderChart(items) {
  const labels = items.map(i => i.date);
  const values = items.map(i => i.score);
  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label: "{% trans 'Wellness' %}", data: values, tension: 0.25, fill: false }] },
    options: { scales: { y: { min: 1, max: 10, ticks: { stepSize: 1 } } } }
  });
}

function renderList(items) {
  const list = document.getElementById("entries-list");
  const empty = document.getElementById("no-entries");
  list.innerHTML = "";
  if (!items || !items.length) {
    empty.classList.remove("d-none");
    return;
  }
  empty.classList.add("d-none");
  items.slice().reverse().forEach(e => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    const left = document.createElement("div");
    left.innerHTML = `<strong>${e.date}</strong> Â· {% trans "Score" %}: ${e.score}`;
    const right = document.createElement("div");
    right.className = "text-muted";
    right.textContent = e.note || "";
    li.appendChild(left);
    li.appendChild(right);
    list.appendChild(li);
  });
}

function applyIntervalState() {
  const interval = parseInt(document.getElementById("rem-interval").value || "3", 10);
  const hour = document.getElementById("rem-hour");
  const minute = document.getElementById("rem-min");
  const disabled = interval === 0;
  hour.disabled = disabled;
  minute.disabled = disabled;
}

function saveEntry() {
  const fd = new FormData(document.getElementById("entry-form"));
  return fetch(apiEntries, {
    method: "POST",
    headers: {
      "X-Requested-With": "XMLHttpRequest",
      "X-CSRFToken": getCsrfToken()
    },
    body: fd,
    credentials: "same-origin"
  }).then(r => r.json());
}

function openSettings() {
  const modal = new bootstrap.Modal(document.getElementById("settingsModal"));
  fetch(apiSettings, { headers: { "X-Requested-With": "XMLHttpRequest" }, credentials: "same-origin" })
    .then(r => r.json())
    .then(d => {
      const s = d.settings || {};
      document.getElementById("rem-hour").value = s.reminder_hour ?? 20;
      document.getElementById("rem-min").value = s.reminder_minute ?? 0;
      document.getElementById("rem-interval").value = s.reminder_interval ?? 3;
      applyIntervalState();
      modal.show();
    });
}

function saveSettings() {
  const fd = new FormData();
  fd.append("reminder_hour", document.getElementById("rem-hour").value || "0");
  fd.append("reminder_minute", document.getElementById("rem-min").value || "0");
  fd.append("reminder_interval", document.getElementById("rem-interval").value || "3");

  return fetch(apiSettings, {
    method: "POST",
    headers: {
      "X-Requested-With": "XMLHttpRequest",
      "X-CSRFToken": getCsrfToken()
    },
    body: fd,
    credentials: "same-origin"
  }).then(r => r.json());
}

document.getElementById("btn-save").addEventListener("click", () => {
  saveEntry().then(() =>
    fetchEntries().then(d => {
      const items = d.items || [];
      renderChart(items);
      renderList(items);
    })
  );
});

document.getElementById("btn-settings").addEventListener("click", openSettings);

document.getElementById("btn-save-settings").addEventListener("click", () => {
  saveSettings().then(() => {
    const modalEl = document.getElementById("settingsModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
  });
});

document.addEventListener("change", (e) => {
  if (e.target && e.target.id === "rem-interval") applyIntervalState();
});

fetchEntries().then(d => {
  const items = d.items || [];
  renderChart(items);
  renderList(items);
});
</script>
{% endblock %}
