{% load i18n static form_tags %}
<link rel="stylesheet" href="{% static 'css/new_styles.css' %}">

<style>
  .section-head {
    display:flex; align-items:center; justify-content:space-between; gap:1rem;
    margin-bottom:1rem;
  }
  .section-title {
    display:flex; align-items:center; gap:.6rem; margin:0;
  }
  .section-title .badge-soft {
    background:rgba(var(--bs-primary-rgb),.12);
    color:var(--bs-primary);
    font-weight:600; border-radius:999px; padding:.35rem .7rem;
  }

  .card-elevated {
    border:0; border-radius:1rem;
    background:linear-gradient(180deg,#fff,rgba(255,255,255,.96));
    box-shadow:0 8px 28px rgba(16,24,40,.08);
  }
  .card-elevated .card-header {
    border:0; background:transparent; padding:1.25rem 1.25rem .5rem;
  }

  .dz {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:.5rem; border:1.5px dashed rgba(0,0,0,.12); border-radius:14px;
    padding:1.75rem; background:rgba(0,0,0,.02); transition:.2s;
    cursor:pointer; text-align:center;
  }
  .dz:hover { border-color:rgba(var(--bs-primary-rgb),.45); background:rgba(var(--bs-primary-rgb),.06); }
  .dz.dragover { border-color:rgba(var(--bs-primary-rgb),.9); background:rgba(13,110,253,.08); }
  .dz .icon {
    width:44px; height:44px; display:grid; place-items:center;
    border-radius:12px; background:rgba(var(--bs-primary-rgb),.12);
  }
  .dz .hint { color:var(--bs-secondary-color); font-size:.95rem; }

  .file-card {
    display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:.5rem .75rem;
    background:#fff;
  }
  .file-card .meta { display:flex; align-items:center; gap:.5rem; min-width:0; }
  .file-card .name { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .exam-card + .exam-card { margin-top:1rem; }
  .exam-card .exam-head {
    display:flex; align-items:center; justify-content:space-between; gap:1rem;
  }
  .exam-card .when {
    display:inline-flex; align-items:center; gap:.5rem; font-weight:600;
  }
  .exam-card .desc { color:var(--bs-secondary-color); }
  .exam-docs { padding:0; margin:0; list-style:none; }
  .exam-docs li {
    display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    padding:.625rem .75rem; border-top:1px solid rgba(0,0,0,.06);
  }
  .doc-link {
    display:inline-flex; align-items:center; gap:.5rem;
    text-decoration:none;
  }
  .doc-link:hover { text-decoration:underline; }
  .doc-time { color:var(--bs-secondary-color); white-space:nowrap; }

  .actions { display:flex; gap:.5rem; }
  .btn-ghost {
    border:1px solid rgba(0,0,0,.08); background:#fff; color:var(--bs-body-color);
  }
  .btn-ghost:hover { border-color:rgba(var(--bs-primary-rgb),.35); color:var(--bs-primary); }

  .links-wrap .link-item { display:flex; gap:.5rem; align-items:center; margin-top:.5rem; }
  .links-wrap .link-item input[type=url]{ flex:1; }

  @media (max-width: 576px){
    .dz { padding:1.25rem; }
    .file-card { flex-direction:column; align-items:flex-start; }
    .exam-card .exam-head { flex-direction:column; align-items:flex-start; }
  }
</style>

<div class="section-head">
  <h2 class="section-title">
    <span class="badge-soft">ðŸ§¾</span>
    <span>{% trans "My examinations" %}</span>
  </h2>
</div>

<div class="card card-elevated mb-4">
  <div class="card-header">
    <h4 class="mb-0">âž• {% trans "Add examination" %}</h4>
  </div>
  <div class="card-body">
    <form id="exam-form" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <input type="hidden" id="exam_id" name="exam_id" value="">

      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label for="exam_date" class="form-label">{% trans "Examination date" %}</label>
          <input type="date" name="exam_date" id="exam_date" class="form-control" required>
        </div>
        <div class="col-12 col-md-8">
          <label for="description" class="form-label">{% trans "Description" %}</label>
          <input type="text" name="description" id="description" class="form-control" placeholder="{% trans 'Short description (optional)' %}">
        </div>

        <div class="col-12">
          <label class="form-label d-flex align-items-center gap-2">
            <i class="bi bi-paperclip"></i>
            <span>{% trans "Files" %}</span>
          </label>

          <div
            id="drop-zone"
            class="dz"
            data-max-size="20971520"
            data-allowed-ext=".pdf,.jpg,.jpeg,.png">
            <div class="icon"><i class="bi bi-cloud-arrow-up"></i></div>
            <div class="fw-semibold">{% trans "Drag & drop files here" %}</div>
            <div class="hint">{% trans "or click to choose" %}</div>

            <input
              type="file"
              id="file-input"
              name="files"
              hidden
              multiple
              accept=".pdf,.jpg,.jpeg,.png">
          </div>

          <div id="file-list" class="mt-3 d-grid gap-2"></div>
        </div>

        <div class="col-12">
          <div class="links-wrap">
            <label class="form-label d-flex align-items-center gap-2">
              <i class="bi bi-link-45deg"></i>
              <span>{% trans "Links (optional)" %}</span>
            </label>

            <input
              type="url"
              id="external_url"
              name="external_url"
              class="form-control mb-2"
              placeholder="{% trans 'Paste a shared link (Google/Dropbox/Yandex/etc.)' %}">

            <div id="link-list"></div>

            <button type="button" id="add-link-btn" class="btn btn-sm btn-ghost mt-2">
              <i class="bi bi-plus-lg me-1"></i> {% trans "Add another link" %}
            </button>

            <small class="text-muted d-block mt-2">
              {% trans "You can attach links instead of files or together with them. HTTP/HTTPS only." %}
            </small>
          </div>
        </div>

        <div class="col-12 d-flex justify-content-end">
          <button type="button" id="submit-exam" class="btn btn-primary">
            <i class="bi bi-upload me-1"></i> {% trans "Save" %}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

{% for exam in exams %}
  <div class="card card-elevated exam-card">
    <div class="card-body">
      <div class="exam-head">
        <div class="d-flex flex-column gap-1">
          <div class="when">
            <i class="bi bi-calendar3"></i>
            <span>{{ exam.exam_date|date:"d.m.Y" }}</span>
          </div>
          {% if exam.description %}
            <div class="desc">{{ exam.description }}</div>
          {% endif %}
        </div>

        <div class="actions">
          <button class="btn btn-ghost btn-sm edit-exam-btn" data-id="{{ exam.id }}" title="{% trans 'Edit' %}">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-ghost btn-sm text-danger delete-exam-btn" data-id="{{ exam.id }}" title="{% trans 'Delete' %}">
            <i class="bi bi-trash3"></i>
          </button>
        </div>
      </div>
    </div>

    <ul class="exam-docs">
      {% for doc in docs_map|get_item:exam.id %}
        <li>
          <div class="d-flex align-items-center gap-2 flex-grow-1">
            {% if doc.external_url %}
              <a href="{{ doc.external_url }}" target="_blank" rel="noopener noreferrer" class="doc-link">
                <i class="bi bi-link-45deg"></i>
                <span class="text-truncate" style="max-width:48ch;">{{ doc.external_url }}</span>
              </a>
            {% else %}
              <a href="{{ doc.file.url }}" target="_blank" rel="noopener noreferrer" class="doc-link">
                <i class="bi bi-file-earmark-text"></i>
                <span class="text-truncate" style="max-width:48ch;">{{ doc.file.name|basename }}</span>
              </a>
            {% endif %}
          </div>
          <small class="doc-time">{{ doc.uploaded_at|date:"d.m.Y H:i" }}</small>
        </li>
      {% empty %}
        <li class="text-muted px-3 py-2">{% trans "No documents" %}</li>
      {% endfor %}
    </ul>
  </div>
{% empty %}
  <div class="alert alert-info">{% trans "No examinations yet." %}</div>
{% endfor %}
