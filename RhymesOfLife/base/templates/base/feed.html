{% extends "base.html" %}
{% load i18n static %}

{# ---- <title> ---- #}
{% block title %}
  {% if current_filter == 'mine' %}
    {% trans "My posts" as section_title %}
  {% elif current_filter == 'subscriptions' %}
    {% trans "Subscriptions" as section_title %}
  {% elif current_filter == 'latest' %}
    {% trans "Latest" as section_title %}
  {% elif current_filter == 'pending' %}
    {% trans "Pending approval" as section_title %}
  {% else %}
    {% trans "Posts" as section_title %}
  {% endif %}
  {{ section_title }} — {{ block.super }}
{% endblock %}

{% block content %}
<style>
  .feed-container{max-width:820px;margin:0 auto}
  .feed-topbar{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);padding:.75rem 0;margin-bottom:1rem;border-bottom:1px solid rgba(0,0,0,.05)}
  .btn-modern{display:inline-flex;align-items:center;gap:.45rem;border:1px solid rgba(var(--bs-primary-rgb),.35);background:linear-gradient(180deg,#fff,rgba(255,255,255,.96));color:var(--bs-primary);border-radius:999px;padding:.5rem 1rem;font-weight:600;box-shadow:0 1px 2px rgba(16,24,40,.06);transition:transform .12s ease,box-shadow .12s ease,background .12s ease,border-color .12s ease}
  .btn-modern:hover{background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));box-shadow:0 6px 16px rgba(16,24,40,.12);transform:translateY(-1px);text-decoration:none;color:var(--bs-primary);border-color:rgba(var(--bs-primary-rgb),.5)}
  .btn-modern:active{transform:translateY(0);box-shadow:0 2px 8px rgba(16,24,40,.12)}
  .btn-modern .bi{font-size:1rem}
  .nav-modern{display:flex;flex-wrap:wrap;gap:.5rem}
  .nav-modern .nav-link{display:inline-flex;align-items:center;gap:.45rem;border:0;border-radius:999px;padding:.5rem .9rem;font-weight:500;color:var(--bs-body-color);opacity:.8}
  .nav-modern .nav-link:hover{opacity:1;background:rgba(0,0,0,.04)}
  .nav-modern .nav-link.active{opacity:1;background:rgba(var(--bs-primary-rgb),.12);color:var(--bs-primary);box-shadow:inset 0 0 0 1px rgba(var(--bs-primary-rgb),.25)}
  .nav-modern .nav-link .bi{font-size:1rem}
  @media (max-width:576px){
    .nav-modern{gap:.5rem}
    .nav-modern .nav-item{flex:1 1 0}
    .nav-modern .nav-link{width:100%;justify-content:center;padding:.75rem 0;border-radius:14px}
    .nav-modern .nav-link .label{display:none}
    .nav-modern .nav-link .bi{font-size:1.25rem;margin:0}
  }
  .fab-new{position:fixed;right:16px;bottom:16px;display:inline-flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--bs-primary),var(--bs-indigo));color:#fff;box-shadow:0 12px 30px rgba(16,24,40,.25);z-index:1050}
  .fab-new:hover{color:#fff;transform:translateY(-1px)}
  @media (min-width:768px){.fab-new{display:none}}
</style>

<div class="container py-3">
  {% include "base/includes/profile_header.html" with profile_user=profile_user info=info posts_count=posts_total followers_count=info.followers_count request=request only %}

  <div class="feed-container">
    <div class="feed-topbar">
      <div class="d-flex justify-content-between align-items-center">
        {# ---- server-side h1 so it shows on first load ---- #}
        {% if current_filter == 'mine' %}
          {% trans "My posts" as section_title %}
        {% elif current_filter == 'subscriptions' %}
          {% trans "Subscriptions" as section_title %}
        {% elif current_filter == 'latest' %}
          {% trans "Latest" as section_title %}
        {% elif current_filter == 'pending' %}
          {% trans "Pending approval" as section_title %}
        {% else %}
          {% trans "Posts" as section_title %}
        {% endif %}
        <h1 id="section-title" class="h4 mb-0">{{ section_title }}</h1>

        <a href="{% url 'post_create' %}" class="btn-modern d-none d-md-inline-flex" aria-label="{% trans 'New post' %}">
          <i class="bi bi-pencil-square"></i> {% trans "New post" %}
        </a>
      </div>

      <nav class="mt-3">
        <ul class="nav nav-pills nav-modern">
          <li class="nav-item">
            <a href="#" data-filter="mine" data-title="{% trans 'My posts' %}"
               class="nav-link {% if current_filter == 'mine' %}active{% endif %}"
               aria-label="{% trans 'My posts' %}" title="{% trans 'My posts' %}">
              <i class="bi bi-person-lines-fill"></i><span class="label">{% trans "My posts" %}</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" data-filter="subscriptions" data-title="{% trans 'Subscriptions' %}"
               class="nav-link {% if current_filter == 'subscriptions' %}active{% endif %}"
               aria-label="{% trans 'Subscriptions' %}" title="{% trans 'Subscriptions' %}">
              <i class="bi bi-people"></i><span class="label">{% trans "Subscriptions" %}</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" data-filter="latest" data-title="{% trans 'Latest' %}"
               class="nav-link {% if current_filter == 'latest' %}active{% endif %}"
               aria-label="{% trans 'Latest' %}" title="{% trans 'Latest' %}">
              <i class="bi bi-stars"></i><span class="label">{% trans "Latest" %}</span>
            </a>
          </li>
          {% if request.user.is_staff %}
          <li class="nav-item">
            <a href="#" data-filter="pending" data-title="{% trans 'Pending approval' %}"
               class="nav-link {% if current_filter == 'pending' %}active{% endif %}"
               aria-label="{% trans 'Pending approval' %}" title="{% trans 'Pending approval' %}">
              <i class="bi bi-hourglass-split"></i><span class="label">{% trans "Pending approval" %}</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>

    <input type="hidden" id="current-filter" value="{{ current_filter }}">

    <div id="posts-container">
      {% include "base/post_list_fragment.html" %}
    </div>
  </div>
</div>

<a href="{% url 'post_create' %}" class="fab-new d-md-none" aria-label="{% trans 'New post' %}">
  <i class="bi bi-pencil-square"></i>
</a>

{% csrf_token %}
<script src="{% static 'js/feed_index.js' %}"></script>
<script src="{% static 'js/posts.js' %}"></script>
<script src="{% static 'js/follow_toggle.js' %}"></script>
<script src="{% static 'js/post_menu.js' %}"></script>

<script>
  document.addEventListener('click', function(e){
    const link = e.target.closest('a[data-filter][data-title]');
    if(!link) return;
    const titleEl = document.getElementById('section-title');
    if(titleEl) titleEl.textContent = link.getAttribute('data-title');
    const parts = document.title.split(' — ');
    const base = parts.length > 1 ? parts.slice(1).join(' — ') : document.title;
    document.title = link.getAttribute('data-title') + ' — ' + base;
  });
</script>
{% endblock %}
