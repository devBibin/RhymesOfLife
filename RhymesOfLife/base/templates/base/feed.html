{% extends "base.html" %}
{% load i18n static %}

{# ---- <title> ---- #}
{% block title %}
  {% if current_filter == 'mine' %}
    {% trans "My posts" as section_title %}
  {% elif current_filter == 'subscriptions' %}
    {% trans "Subscriptions" as section_title %}
  {% elif current_filter == 'latest' %}
    {% trans "Latest" as section_title %}
  {% elif current_filter == 'pending' %}
    {% trans "Pending approval" as section_title %}
  {% else %}
    {% trans "Posts" as section_title %}
  {% endif %}
  {{ section_title }} — {{ block.super }}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/feed.css' %}">
<link rel="stylesheet" href="{% static 'css/post_cards.css' %}">
<div class="feed-page py-3">
  {% include "base/includes/profile_header.html" with profile_user=profile_user info=info posts_count=posts_total followers_count=info.followers_count request=request only %}

  <div class="feed-container">
    <div class="feed-topbar">
      <div class="d-flex justify-content-between align-items-center">
        {# ---- server-side h1 so it shows on first load ---- #}
        {% if current_filter == 'mine' %}
          {% trans "My posts" as section_title %}
        {% elif current_filter == 'subscriptions' %}
          {% trans "Subscriptions" as section_title %}
        {% elif current_filter == 'latest' %}
          {% trans "Latest" as section_title %}
        {% elif current_filter == 'pending' %}
          {% trans "Pending approval" as section_title %}
        {% else %}
          {% trans "Posts" as section_title %}
        {% endif %}
        <h1 id="section-title" class="h4 mb-0">{{ section_title }}</h1>

        <a href="{% url 'post_create' %}" class="btn-modern d-none d-md-inline-flex" aria-label="{% trans 'New post' %}">
          <i class="bi bi-pencil-square"></i> {% trans "New post" %}
        </a>
      </div>

      <nav class="mt-3">
        <ul class="nav nav-pills nav-modern">
          <li class="nav-item">
            <a href="#" data-filter="mine" data-title="{% trans 'My posts' %}"
               class="nav-link {% if current_filter == 'mine' %}active{% endif %}"
               aria-label="{% trans 'My posts' %}" title="{% trans 'My posts' %}">
              <i class="bi bi-person-lines-fill"></i><span class="label">{% trans "My posts" %}</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" data-filter="subscriptions" data-title="{% trans 'Subscriptions' %}"
               class="nav-link {% if current_filter == 'subscriptions' %}active{% endif %}"
               aria-label="{% trans 'Subscriptions' %}" title="{% trans 'Subscriptions' %}">
              <i class="bi bi-people"></i><span class="label">{% trans "Subscriptions" %}</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" data-filter="latest" data-title="{% trans 'Latest' %}"
               class="nav-link {% if current_filter == 'latest' %}active{% endif %}"
               aria-label="{% trans 'Latest' %}" title="{% trans 'Latest' %}">
              <i class="bi bi-stars"></i><span class="label">{% trans "Latest" %}</span>
            </a>
          </li>
          {% if request.user.is_staff %}
          <li class="nav-item">
            <a href="#" data-filter="pending" data-title="{% trans 'Pending approval' %}"
               class="nav-link {% if current_filter == 'pending' %}active{% endif %}"
               aria-label="{% trans 'Pending approval' %}" title="{% trans 'Pending approval' %}">
              <i class="bi bi-hourglass-split"></i><span class="label">{% trans "Pending approval" %}</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>

    <input type="hidden" id="current-filter" value="{{ current_filter }}">

    <div id="posts-container">
      {% include "base/post_list_fragment.html" %}
    </div>
  </div>
</div>

<a href="{% url 'post_create' %}" class="fab-new d-md-none" aria-label="{% trans 'New post' %}">
  <i class="bi bi-pencil-square"></i>
</a>

{% csrf_token %}
<script src="{% static 'js/feed_index.js' %}"></script>
<script src="{% static 'js/posts.js' %}"></script>
<script src="{% static 'js/follow_toggle.js' %}"></script>
<script src="{% static 'js/post_menu.js' %}"></script>

<script>
  document.addEventListener('click', function(e){
    const link = e.target.closest('a[data-filter][data-title]');
    if(!link) return;
    const titleEl = document.getElementById('section-title');
    if(titleEl) titleEl.textContent = link.getAttribute('data-title');
    const parts = document.title.split(' — ');
    const base = parts.length > 1 ? parts.slice(1).join(' — ') : document.title;
    document.title = link.getAttribute('data-title') + ' — ' + base;
  });
</script>
{% endblock %}
