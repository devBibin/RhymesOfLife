{% extends 'base.html' %}
{% load static i18n avatar_tags %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-sm card-profile">
    <div class="card-body">

      <div class="text-center mb-4">
        <div class="d-inline-block position-relative">
          <img
            id="avatar-img"
            src="{% avatar_url info %}"
            data-default-src="{% static 'images/default-avatar.png' %}"
            class="rounded-circle avatar-editable"
            style="width:140px;height:140px;object-fit:cover;"
            alt="{% trans 'User avatar' %}">
          <div id="avatar-menu" class="avatar-menu">
            <button type="button" class="dropdown-item" id="change-avatar-btn">ðŸ“¤ {% trans "Upload new" %}</button>
            <button type="button" class="dropdown-item text-danger" id="delete-avatar-btn">ðŸ—‘ {% trans "Delete" %}</button>
          </div>
        </div>
        <h5 class="mb-0 mt-3">{{ request.user.get_full_name|default:request.user.username }}</h5>
      </div>

      <input type="file" id="avatar-input" name="avatar" hidden form="profile-form">
      <input type="hidden" id="delete-avatar" name="delete_avatar" value="" form="profile-form">

      <form id="profile-form" action="{% url 'profile_edit' %}" method="post" enctype="multipart/form-data" class="row g-3">
        {% csrf_token %}

        <div class="col-6">
          <label class="form-label">{% trans "First name" %} <span class="text-danger">*</span></label>
          <input type="text" name="first_name" class="form-control" value="{{ info.first_name }}" required aria-required="true">
        </div>
        <div class="col-6">
          <label class="form-label">{% trans "Last name" %} <span class="text-danger">*</span></label>
          <input type="text" name="last_name" class="form-control" value="{{ info.last_name }}" required aria-required="true">
        </div>

        <div class="col-6">
          <label class="form-label">{% trans "Email" %}</label>
          <input type="email" name="email" class="form-control" value="{{ info.email }}">
        </div>

        <div class="col-6">
          <label class="form-label">{% trans "Date of birth" %} <span class="text-danger">*</span></label>
          <div class="row g-2">
            <div class="col-4">
              <select name="day" class="form-select" required aria-required="true">
                <option value="">{% trans "Day" %}</option>
                {% for d in day_range %}
                  <option value="{{ d }}" {% if info.birth_date and info.birth_date.day == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-4">
              <select name="month" class="form-select" required aria-required="true">
                <option value="">{% trans "Month" %}</option>
                {% for num,name in months_list %}
                  <option value="{{ num }}" {% if info.birth_date and info.birth_date.month == num %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-4">
              <select name="year" class="form-select" required aria-required="true">
                <option value="">{% trans "Year" %}</option>
                {% for y in year_range %}
                  <option value="{{ y }}" {% if info.birth_date and info.birth_date.year == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">{% trans "About me" %}</label>
          <textarea name="about_me" class="form-control" rows="4" maxlength="1000" placeholder="{% trans 'A few words about yourself' %}">{{ info.about_me }}</textarea>
          <div class="form-text">{% trans "Up to 250 characters." %}</div>
        </div>

        <div class="col-12">
          <label class="form-label">{% trans "Syndromes" %}</label>
          <div class="row gy-2">
            {% for code,label in syndrome_choices %}
              <div class="col-12 col-md-6">
                <div class="border rounded p-2 h-100">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="syndromes" value="{{ code }}" id="s-{{ code }}"
                           {% if info.syndromes and code in info.syndromes %}checked{% endif %}>
                    <label class="form-check-label" for="s-{{ code }}">{{ label }}</label>
                  </div>
                  <div class="form-check mt-1">
                    <input class="form-check-input"
                           type="checkbox"
                           name="confirmed_syndromes"
                           value="{{ code }}"
                           id="sync-{{ code }}"
                           data-main="#s-{{ code }}"
                           {% if info.confirmed_syndromes and code in info.confirmed_syndromes %}checked{% endif %}
                           {% if not info.syndromes or code not in info.syndromes %}disabled{% endif %}>
                    <label class="form-check-label" for="sync-{{ code }}">{% trans "Genetically confirmed" %}</label>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">{% trans "Telegram" %}</label>
          <div class="border rounded p-3 d-flex flex-wrap align-items-center gap-2">
            {% if tg_is_verified %}
              <span class="badge bg-success">{% trans "Linked" %}</span>
              {% if tg_username %}<span class="text-muted">@{{ tg_username }}</span>{% endif %}
              <form action="{% url 'telegram_unlink' %}" method="post" class="ms-auto">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm">{% trans "Unlink Telegram" %}</button>
              </form>
            {% else %}
              {% if tg_not_configured %}
                <span class="text-muted">{% trans "Telegram bot is not configured." %}</span>
              {% else %}
                {% if tg_link %}
                  <a href="{{ tg_link }}" target="_blank" rel="noopener" class="btn btn-primary btn-sm">
                    {% trans "Link Telegram" %}
                  </a>
                {% else %}
                  <span class="text-muted">{% trans "Activation link is not available." %}</span>
                {% endif %}
                <form action="{% url 'telegram_regenerate' %}" method="post" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-secondary btn-sm">{% trans "Regenerate link" %}</button>
                </form>
              {% endif %}
            {% endif %}
          </div>
        </div>

        {% if error %}
          <div class="col-12">
            <div class="alert alert-danger mt-2">{{ error }}</div>
          </div>
        {% endif %}

        <div class="col-12 text-end mt-2">
          <button type="submit" class="btn btn-primary px-4">{% trans "Save" %}</button>
        </div>
      </form>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded",function(){
  document.querySelectorAll('input[name="confirmed_syndromes"]').forEach(function(c){
    var m=document.querySelector(c.getAttribute("data-main"));
    var sync=function(){var on=!!(m&&m.checked);c.disabled=!on;if(!on)c.checked=false;};
    if(m){m.addEventListener("change",sync);sync();}else{c.disabled=true;c.checked=false;}
  });

  var avatarImg=document.getElementById("avatar-img");
  var menu=document.getElementById("avatar-menu");
  var changeBtn=document.getElementById("change-avatar-btn");
  var delBtn=document.getElementById("delete-avatar-btn");
  var input=document.getElementById("avatar-input");
  var delInput=document.getElementById("delete-avatar");

  if(avatarImg && menu){
    avatarImg.addEventListener("click",function(){menu.classList.toggle("show");});
    document.addEventListener("click",function(e){if(!menu.contains(e.target) && e.target!==avatarImg){menu.classList.remove("show");}});
  }
  if(changeBtn && input){
    changeBtn.addEventListener("click",function(){delInput.value="";input.click();});
  }
  if(delBtn){
    delBtn.addEventListener("click",function(){delInput.value="1";document.getElementById("profile-form").submit();});
  }
  if(input){
    input.addEventListener("change",function(){if(input.files&&input.files[0]){delInput.value="";document.getElementById("profile-form").submit();}});
  }
});
</script>
{% endblock %}
