{% extends "wiki/base.html" %}
{% load wiki_tags i18n sekizai_tags %}
{% load static %}

{% block wiki_pagetitle %}{{ article.current_revision.title }}{% endblock %}

{% block wiki_breadcrumbs %}
  {% include "wiki/includes/breadcrumbs.html" %}
{% endblock %}

{% block wiki_contents %}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
  <div id="article-container">
    <nav id="article-menu" class="navbar navbar-expand-md nav-pills">
      <ul class="navbar-nav w-75">
        <li class="float-left nav-item" id="article-title-li">
          <h1 id="article-title">
            {{ article.current_revision.title }}
            <small style="font-size: 14px;">
              {% if urlpath.parent %}
                <a href="{% url 'wiki:get' path=urlpath.path %}" class="nav-link"><span class="fa fa-bookmark"></span> {{ urlpath.slug }}</a>
              {% endif %}
              {% if article.current_revision.locked %}
                <span class="fa fa-lock"></span> {% trans "locked" %}
              {% endif %}
            </small>
          </h1>
        </li>
      </ul>
      <ul class="nav navbar-nav ml-auto w-100 justify-content-end">
        {% include "wiki/includes/article_menu.html" %}
      </ul>
    </nav>

    <div>
      {% block wiki_contents_tab %}
      {% endblock %}
    </div>

    <!-- –ë–ª–æ–∫ –ª–∞–π–∫–æ–≤ -->
    <div class="mt-4 mb-4">
      {% if request.user.is_authenticated %}
        <button id="like-btn"
                class="btn {% if user_liked %}btn-danger{% else %}btn-outline-danger{% endif %}"
                data-article-id="{{ article.id }}"
                data-like-url="{% url 'wiki_toggle_like' article_id=article.id %}"
                data-liked="{{ user_liked|yesno:'true,false' }}">
          {% if user_liked %}üíñ{% else %}‚ù§Ô∏è{% endif %}
          <span id="like-count">{{ article.likes.count }}</span>
        </button> 
      {% else %}
        <p class="text-muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫.</p>
      {% endif %}
    </div>

    <!-- –ë–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div class="mt-5">
      <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ article.comments.count }})</h4>
      <ul class="list-unstyled">
        {% for comment in article.comments.all %}
          <li class="mb-3 p-2 border rounded">
            <strong>{{ comment.user }}</strong>: {{ comment.text }}
            <em class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</em>
          </li>
        {% empty %}
          <li class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</li>
        {% endfor %}
      </ul>

      {% if request.user.is_authenticated %}
        <form method="post" action="{% url 'wiki_post_comment' article_id=article.id %}" class="mt-3">
          {% csrf_token %}
          <textarea name="comment" class="form-control" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="3" required></textarea>
          <button type="submit" class="btn btn-primary mt-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
      {% else %}
        <p class="text-muted">
          <a href="{% url 'login' %}?next={{ request.path }}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
        </p>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block wiki_footer_prepend %}
  <p style="margin-bottom: 10px;"><em>{% trans "This article was last modified:" %} {{ article.current_revision.modified }}</em></p>
{% endblock %}

{% addtoblock "js" %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É–∫–∏
    function getCookie(name) {
        const cookieString = document.cookie || '';
        const cookies = cookieString.split(';');
        
        for (const cookieRaw of cookies) {
            const cookie = cookieRaw.trim();
            if (cookie.startsWith(name + '=')) {
                return decodeURIComponent(cookie.substring(name.length + 1));
            }
        }
        return null;
    }

    const likeBtn = document.getElementById('like-btn');
    
    // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –ª–∞–π–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    if (likeBtn) {
        const csrftoken = getCookie('csrftoken');
        
        likeBtn.addEventListener('click', function() {
            const likeUrl = this.getAttribute('data-like-url');
            
            fetch(likeUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (response.status === 403) {
                    throw new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                }
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∏ —Å—á–µ—Ç—á–∏–∫
                const icon = data.liked ? 'üíñ' : '‚ù§Ô∏è';
                likeBtn.innerHTML = `${icon} <span id="like-count">${data.total_likes}</span>`;
                likeBtn.setAttribute('data-liked', data.liked.toString());
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏
                if (data.liked) {
                    likeBtn.classList.remove('btn-outline-danger');
                    likeBtn.classList.add('btn-danger');
                } else {
                    likeBtn.classList.remove('btn-danger');
                    likeBtn.classList.add('btn-outline-danger');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ª–∞–π–∫–∞:', error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            });
        });
    } else {
        console.log('–ö–Ω–æ–ø–∫–∞ –ª–∞–π–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
    }
});
</script>
{% endaddtoblock %}