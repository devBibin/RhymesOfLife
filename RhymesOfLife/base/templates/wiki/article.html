{% extends "wiki/base.html" %}
{% load wiki_tags i18n sekizai_tags %}
{% load static %}
{% load wiki_extras %}

{% block wiki_pagetitle %}{{ article.current_revision.title }}{% endblock %}

{% block wiki_breadcrumbs %}
  {% include "wiki/includes/breadcrumbs.html" %}
{% endblock %}

{% block wiki_contents %}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
  <div id="article-container">
    <nav id="article-menu" class="navbar navbar-expand-md nav-pills">
      <ul class="navbar-nav w-75">
        <li class="float-left nav-item" id="article-title-li">
          <h1 id="article-title">
            {{ article.current_revision.title }}
            <small style="font-size: 14px;">
              {% if urlpath.parent %}
                <a href="{% url 'wiki:get' path=urlpath.path %}" class="nav-link"><span class="fa fa-bookmark"></span> {{ urlpath.slug }}</a>
              {% endif %}
              {% if article.current_revision.locked %}
                <span class="fa fa-lock"></span> {% trans "locked" %}
              {% endif %}
            </small>
          </h1>
        </li>
      </ul>
      <ul class="nav navbar-nav ml-auto w-100 justify-content-end">
        {% include "wiki/includes/article_menu.html" %}
      </ul>
    </nav>

    <div>
      {% block wiki_contents_tab %}
      {% endblock %}
    </div>

    <div class="mt-4 mb-4">
      {% if request.user.is_authenticated %}
        {% get_like_info article as like_info %}
        <form id="like-form" method="post" action="{% url 'wiki_toggle_like' article_id=article.id %}">
          {% csrf_token %}
          <button type="submit" 
                  id="like-btn"
                  class="btn {% if like_info.user_liked %}btn-danger{% else %}btn-outline-danger{% endif %}">
            {% if like_info.user_liked %}üíñ{% else %}‚ù§Ô∏è{% endif %}
            <span id="like-count">{{ like_info.active_likes_count }}</span>
          </button> 
        </form>
      {% else %}
        <p class="text-muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫.</p>
      {% endif %}
    </div>

    <div class="mt-5">
      <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ article.comments.count }})</h4>
      <ul class="list-unstyled">
        {% for comment in article.comments.all %}
          <li class="mb-3 p-2 border rounded">
            <strong>{{ comment.user_info.user.username }}</strong>: {{ comment.text }}
            <em class="text-muted">{{ comment.created_at|date:"d.m.Y H:i" }}</em>
          </li>
        {% empty %}
          <li class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</li>
        {% endfor %}
      </ul>

      {% if request.user.is_authenticated %}
        <form method="post" action="{% url 'wiki_post_comment' article_id=article.id %}" class="mt-3">
          {% csrf_token %}
          <textarea name="comment" class="form-control" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="3" required></textarea>
          <button type="submit" class="btn btn-primary mt-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
      {% else %}
        <p class="text-muted">
          <a href="{% url 'login' %}?next={{ request.path }}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
        </p>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block wiki_footer_prepend %}
  <p style="margin-bottom: 10px;"><em>{% trans "This article was last modified:" %} {{ article.current_revision.modified }}</em></p>
{% endblock %}

{% addtoblock "js" %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeForm = document.getElementById('like-form');

    if (likeForm) {
        likeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const likeBtn = document.getElementById('like-btn');
            const likeCount = document.getElementById('like-count');

            const originalHtml = likeBtn.innerHTML;
            likeBtn.innerHTML = '‚è≥';
            likeBtn.disabled = true;

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.status === 403) {
                    throw new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.');
                }
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const icon = data.liked ? 'üíñ' : '‚ù§Ô∏è';
                if (likeCount) {
                    likeCount.textContent = data.total_likes;
                }
                likeBtn.innerHTML = icon + (likeCount ? ` <span id="like-count">${data.total_likes}</span>` : '');
                likeBtn.classList.toggle('btn-danger', data.liked);
                likeBtn.classList.toggle('btn-outline-danger', !data.liked);
                setTimeout(() => {
                    likeBtn.disabled = false;
                }, 500);
            })
            .catch(() => {
                likeBtn.innerHTML = originalHtml;
                likeBtn.disabled = false;
            });
        });
    }
});
</script>
{% endaddtoblock %}
