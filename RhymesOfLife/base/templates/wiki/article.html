{% extends "wiki/base.html" %}
{% load wiki_tags i18n sekizai_tags %}
{% load static %}
{% load wiki_extras %}

{% block wiki_pagetitle %}{{ article.current_revision.title }}{% endblock %}

{% block wiki_breadcrumbs %}
  {% include "wiki/includes/breadcrumbs.html" %}
{% endblock %}

{% block wiki_contents %}
  <link rel="stylesheet" href="{% static 'css/new_styles.css' %}">
  <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
  <div id="article-container">
    <nav id="article-menu" class="navbar navbar-expand-md nav-pills">
      <ul class="navbar-nav w-75">
        <li class="float-left nav-item" id="article-title-li">
          <h1 id="article-title">
            {{ article.current_revision.title }}
            <small style="font-size: 14px;">
              {% if urlpath.parent %}
                <a href="{% url 'wiki:get' path=urlpath.path %}" class="nav-link">
                  <span class="fa fa-bookmark"></span> {{ urlpath.slug }}
                </a>
              {% endif %}
              {% if article.current_revision.locked %}
                <span class="fa fa-lock"></span> {% trans "locked" %}
              {% endif %}
            </small>
          </h1>
        </li>
      </ul>
      <ul class="nav navbar-nav ml-auto w-100 justify-content-end">
        {% include "wiki/includes/article_menu.html" %}
      </ul>
    </nav>

    <div>
      {% block wiki_contents_tab %}{% endblock %}
    </div>

    {% if request.path|is_view_page %}
    <div class="mt-4 mb-4">
      {% if request.user.is_authenticated %}
        {% get_like_info article as like_info %}
        <form id="like-form" method="post" action="{% url 'wiki_toggle_like' article_id=article.id %}">
          {% csrf_token %}
          <button type="submit" 
                  id="like-btn"
                  class="btn {% if like_info.user_liked %}btn-danger{% else %}btn-outline-danger{% endif %}">
            {% if like_info.user_liked %}üíñ{% else %}‚ù§Ô∏è{% endif %}
            <span id="like-count">{{ like_info.active_likes_count }}</span>
          </button> 
        </form>
      {% else %}
        <p class="text-muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫.</p>
      {% endif %}
    </div>

    <div class="mt-5">
      <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<span id="comment-count">{{ article.custom_fields.comments_count }}</span>)</h4>
      <ul class="list-unstyled" id="comment-list">
        <li class="text-muted" id="loading-comments">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤...</li>
      </ul>

      {% if request.user.is_authenticated %}
        <form method="post" action="{% url 'wiki_post_comment' article_id=article.id %}" class="mt-3" id="comment-form">
          {% csrf_token %}
          <textarea name="comment" class="form-control" placeholder="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." rows="3" required></textarea>
          <button type="submit" class="btn btn-primary mt-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
      {% else %}
        <p class="text-muted">
          <a href="{% url 'login' %}?next={{ request.path }}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
        </p>
      {% endif %}
    </div>
  {% endif %}

{% endblock %}

{% block wiki_footer_prepend %}
  <p style="margin-bottom: 10px;">
    <em>{% trans "This article was last modified:" %} {{ article.current_revision.modified }}</em>
  </p>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const articleId = "{{ article.id }}";
    const commentList = document.getElementById('comment-list');
    const commentCount = document.getElementById('comment-count');

    fetch(`/articles/${articleId}/comments/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        commentList.innerHTML = '';
        const comments = data.comments || [];

        if (comments.length === 0) {
            const li = document.createElement('li');
            li.className = 'text-muted';
            li.id = 'no-comments';
            li.innerText = '–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.';
            commentList.appendChild(li);
        } else {
            comments.forEach(item => {
                const comment = item.comment;
                const li = document.createElement('li');
                li.classList.add('mb-3', 'p-2', 'border', 'rounded');
                li.innerHTML = `<strong>${item.username}</strong>: ${comment.text} <em class="text-muted">${formatDate(comment.created_at)}</em>`;
                commentList.appendChild(li);
            });
        }
    })
    .catch(err => {
        commentList.innerHTML = '<li class="text-danger">Failed to load comments üò¢</li>';
        console.error(err);
    });

    const likeForm = document.getElementById('like-form');
    if (likeForm) {
        likeForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(likeForm);
            const btn = document.getElementById('like-btn');

            fetch(likeForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                btn.innerHTML = (data.liked ? 'üíñ' : '‚ù§Ô∏è') + ` <span id="like-count">${data.total_likes}</span>`;
                btn.classList.toggle('btn-danger', data.liked);
                btn.classList.toggle('btn-outline-danger', !data.liked);
            })
            .catch(err => alert("–û—à–∏–±–∫–∞: " + err.message));
        });
    }

    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
        commentForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(commentForm);
            const url = commentForm.action;
            const textarea = commentForm.querySelector('textarea');
            const submitBtn = commentForm.querySelector('button[type="submit"]');

            submitBtn.disabled = true;
            submitBtn.innerText = '‚è≥';

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) throw new Error(data.error);

                const comment = data.comment;
                const li = document.createElement('li');
                li.classList.add('mb-3', 'p-2', 'border', 'rounded');
                li.innerHTML = `<strong>${data.username}</strong>: ${comment.text} <em class="text-muted">${formatDate(comment.created_at)}</em>`;
                commentList.appendChild(li);

                textarea.value = '';

                if (commentCount) {
                    commentCount.innerText = parseInt(commentCount.innerText) + 1;
                }
                const noComments = document.getElementById('no-comments');
                if (noComments) noComments.remove();
            })
            .catch(err => {
                alert(err.message || "Create new comment error.");
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            });
        });
    }

    function formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
});
</script>
{% endblock %}
